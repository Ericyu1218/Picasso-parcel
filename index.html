<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <title>Picasso Parcel PWA</title>
  
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#f8f9fa">
  <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2965/2965302.png">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>

  <style>
    :root { --primary-color: #333; --accent-color: #0d6efd; --bg-color: #f8f9fa; --check-color: #198754; }
    body { background-color: var(--bg-color); padding-bottom: 80px; font-family: 'Segoe UI', system-ui, sans-serif; user-select: none; }

    .sync-badge { position: absolute; top: -5px; right: -5px; background-color: #ff3b30; color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.7rem; font-weight: bold; display:none; border: 2px solid white; }
    .app-header { background-color: white; color: #333; padding: 10px 15px; position: sticky; top: 0; z-index: 1020; display: flex; align-items: center; box-shadow: 0 4px 12px rgba(0,0,0,0.08); justify-content: space-between; }
    .app-logo { height: 32px; margin-right: 12px; border-right: 1px solid #ddd; padding-right: 12px; }
    .app-title { font-size: 0.9rem; font-weight: 700; letter-spacing: 1px; margin: 0; text-transform: uppercase; line-height: 1.1; }
    .menu-btn { border: none; background: transparent; font-size: 1.5rem; color: #333; padding: 0 10px; cursor: pointer; }

    .custom-dropdown { position: absolute; top: 100%; left: 0; right: 0; z-index: 1050; background: white; border: 1px solid #ddd; border-radius: 0 0 8px 8px; max-height: 250px; overflow-y: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: none; }
    .dropdown-item { padding: 12px; border-bottom: 1px solid #f0f0f0; cursor: pointer; }
    
    .parcel-card { background: white; border-radius: 12px; margin-bottom: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); border: 2px solid transparent; overflow: hidden; }
    .parcel-card.selected { border-color: var(--accent-color); background-color: #f0f7ff; }
    .parcel-img { width: 70px; height: 70px; object-fit: cover; border-radius: 8px; background: #eee; cursor: zoom-in; }
    
    .temp-item { background: #fff; border-left: 4px solid var(--accent-color); padding: 10px; border-radius: 8px; margin-bottom: 8px; display: flex; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    
    .nav-bottom { position: fixed; bottom: 0; width: 100%; background: white; border-top: 1px solid #ddd; z-index: 1000; height: 70px; display: flex; }
    .nav-link { color: #adb5bd; border: none; background: none; font-size: 0.75rem; flex: 1; padding-top: 10px; text-align: center; text-decoration: none; cursor: pointer; }
    .nav-link.active { color: var(--primary-color); font-weight: bold; }
    
    #signature-pad { border: 2px dashed #ccc; background: white; width: 100%; height: 250px; touch-action: none; border-radius: 8px; }
    #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 2000; display: none; justify-content: center; align-items: center; flex-direction: column; }
    .email-warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; padding: 10px; border-radius: 8px; font-size: 0.85rem; display: none; margin-bottom: 15px; }

    /* Inventory Chips */
    .inv-section { margin-bottom: 20px; background: #fff; border: 1px solid #e0e0e0; border-radius: 6px; overflow: hidden; }
    .inv-header { background: #f2f2f2; padding: 10px 15px; font-weight: bold; border-left: 5px solid #333; font-size: 0.95rem; color: #333; display: flex; justify-content: space-between; align-items: center; }
    .inv-body { padding: 5px 15px; }
    .inv-row { display: flex; align-items: flex-start; padding: 10px 0; border-bottom: 1px solid #eee; }
    .inv-row:last-child { border-bottom: none; }
    .inv-label { width: 100px; min-width: 100px; font-size: 0.75rem; color: #888; font-weight: 600; padding-top: 4px; }
    .inv-chips { display: flex; flex-wrap: wrap; gap: 6px; flex-grow: 1; }
    .inv-chip { 
      background: #fff; border: 1px solid #ccc; color: #333; 
      padding: 3px 8px; border-radius: 4px; font-size: 0.85rem; font-weight: 500; 
      box-shadow: 0 1px 2px rgba(0,0,0,0.05); min-width: 45px; text-align: center;
      cursor: pointer; transition: all 0.2s; 
    }
    .inv-chip:active { transform: scale(0.95); }
    .inv-chip.checked { background-color: var(--check-color); color: white; border-color: var(--check-color); box-shadow: 0 2px 4px rgba(25, 135, 84, 0.3); }

    #offlineBanner { display: none; background: #333; color: #fff; text-align: center; padding: 4px; font-size: 0.75rem; font-weight: bold; }
    #installBtn { display: none; }
  </style>
</head>
<body>

<div id="offlineBanner">üì° OFFLINE MODE</div>

<div class="app-header">
  <div class="d-flex align-items-center">
    <div class="app-title me-2">PICASSO<br>PARCEL PWA</div>
    <button id="installBtn" class="btn btn-sm btn-outline-primary" onclick="installPWA()">Install App</button>
  </div>
  <div class="d-flex align-items-center">
    <div class="position-relative me-3" id="syncStatusIcon">
      <span style="font-size: 1.5rem;">‚òÅÔ∏è</span>
      <span id="syncCountBadge" class="sync-badge">0</span>
    </div>
    <button class="menu-btn" type="button" data-bs-toggle="offcanvas" data-bs-target="#sideMenu">‚ò∞</button>
  </div>
</div>

<div id="loadingOverlay">
  <div class="spinner-border text-primary"></div>
  <div class="mt-2 fw-bold">Processing...</div>
</div>

<div class="offcanvas offcanvas-end w-100" tabindex="-1" id="sideMenu" style="max-width: 600px;">
  <div class="offcanvas-header bg-primary text-white">
    <h5 class="offcanvas-title fw-bold">üì¶ Storage Visualizer</h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body bg-light">
    <div class="d-grid gap-2 mb-3">
        <button class="btn btn-primary fw-bold" onclick="forceUpdateCache()">üîÑ Sync All Data (Residents + Inventory)</button>
    </div>
    <div class="d-flex justify-content-between align-items-center mb-2">
        <span class="text-muted small fw-bold" id="invTotalBadge">Total: 0</span>
    </div>
    <div id="invVisualizerArea"><div class="text-center text-muted py-5">No Data</div></div>
    <div class="mt-4 pt-4 border-top text-center text-muted small">
       <p id="cacheStatusText">Checking Data...</p>
       <small class="text-muted">Version 3.0 (GitHub PWA)</small>
    </div>
  </div>
</div>

<div id="tab-receive" class="container py-4">
  <div class="card p-3 border-0 shadow-sm mb-4">
    <h6 class="fw-bold mb-3 text-uppercase">üì• Batch Receive</h6>
    <div class="form-check form-switch mb-3 bg-light p-2 rounded border">
        <input class="form-check-input ms-0 me-2" type="checkbox" id="chkManualEntry" onchange="toggleManualEntry()">
        <label class="form-check-label fw-bold text-danger" for="chkManualEntry">‚ö†Ô∏è Not in List (Manual Entry)</label>
    </div>
    <div id="areaSearch" class="mb-3 position-relative">
      <label class="small fw-bold text-muted">UNIT / RESIDENT SEARCH</label>
      <input type="text" class="form-control form-control-lg" id="inputUnit" placeholder="Search Unit or Name..." autocomplete="off">
      <div id="unitDropdown" class="custom-dropdown"></div>
      <div id="emailWarning" class="email-warning fw-bold mt-2">‚ö†Ô∏è No Email found.</div>
    </div>
    <div id="areaManual" class="mb-3 d-none row g-2">
        <div class="col-4"><label class="small fw-bold text-muted">UNIT</label><input type="text" class="form-control" id="manualUnit" placeholder="Unit"></div>
        <div class="col-8"><label class="small fw-bold text-muted">NAME</label><input type="text" class="form-control" id="manualName" placeholder="Name"></div>
        <div class="col-12"><small class="text-danger fw-bold">* Manual entries will NOT receive emails.</small></div>
    </div>
    <div class="row g-2 mb-3">
      <div class="col-6"><label class="small fw-bold text-muted">LOCATION</label><select class="form-select" id="inputLocation"></select></div>
      <div class="col-6"><label class="small fw-bold text-muted">COURIER</label><select class="form-select" id="inputCourier"></select></div>
    </div>
    <div class="mb-3">
      <label class="small fw-bold text-muted">PHOTO EVIDENCE</label>
      <input type="file" class="form-control" id="inputPhoto" accept="image/*" capture="environment">
      <div id="photoPreview" class="mt-2 d-none text-center"><img id="previewImg" src="" style="height: 100px; border-radius: 8px; border: 1px solid #ddd;"></div>
    </div>
    <button class="btn btn-primary w-100 py-3 fw-bold shadow-sm" onclick="addParcelToList()">Ôºã ADD TO LIST</button>
  </div>
  <div id="tempBatchArea"></div>
  <button id="btnFinalSubmit" class="btn btn-dark w-100 py-3 mt-3 fw-bold shadow d-none" onclick="submitBatch()">CONFIRM (<span id="batchCount">0</span>)</button>
</div>

<div id="tab-pickup" class="container py-4" style="display:none;">
  <div class="input-group mb-3 shadow-sm">
    <span class="input-group-text bg-white border-end-0">üîç</span>
    <input type="text" class="form-control border-start-0 ps-0" id="searchBox" placeholder="Search Unit or Name..." onkeyup="filterParcels()">
  </div>
  <div id="parcelListArea" class="pb-5"></div>
  <button id="btnPickup" class="btn btn-primary position-fixed shadow-lg py-3 fw-bold d-none" style="bottom:85px; left:20px; right:20px; z-index:999" onclick="openSignModal()">CONFIRM PICKUP (<span id="selectedCount">0</span>)</button>
</div>

<div id="tab-history" class="container py-4" style="display:none;">
  <div class="input-group mb-3 shadow-sm">
    <span class="input-group-text bg-white border-end-0">üìú</span>
    <input type="text" class="form-control border-start-0 ps-0" id="historySearch" placeholder="Search History..." onkeyup="debouncedHistorySearch()">
  </div>
  <div id="historyListArea"></div>
</div>

<div class="nav-bottom">
  <button class="nav-link active" onclick="switchTab('receive', this)"><div>üì•</div>Receive</button>
  <button class="nav-link" onclick="switchTab('pickup', this)"><div>üì§</div>Pickup</button>
  <button class="nav-link" onclick="switchTab('history', this)"><div>üìú</div>History</button>
</div>

<div class="modal fade" id="signModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0 shadow"><div class="modal-header border-0"><h5 class="modal-title fw-bold">Sign Here</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body text-center"><canvas id="signature-pad"></canvas><div class="text-end mt-2"><button class="btn btn-link text-muted btn-sm text-decoration-none" onclick="signaturePad.clear()">Clear</button></div></div><div class="modal-footer border-0"><button class="btn btn-dark w-100 py-3 fw-bold" onclick="processPickup()">CONFIRM</button></div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // üü¢ Ë´ãÂú®ÈÄôË£°Ë≤º‰∏ä‰Ω†ÂàöÂàö "ÈáçÊñ∞ÈÉ®ÁΩ≤" ÂæåÁöÑÊñ∞Á∂≤ÂùÄÔºÅ
  const API_URL = "https://script.google.com/macros/s/AKfycbwcHL0r_GEV8v2vfjwviL8n-kDZTDfUY0-7D1c8NHu7-oTi0NbnxS_I09jC5ooWU0w61g/exec";

  let residentData = [], config = {}, tempBatch = [], allParcels = [], selectedIds = new Set();
  let selectedResident = null, signaturePad = null, historyTimeout = null, isSyncing = false;
  let deferredPrompt;

  // 1. ÂÆöÁæ© resizeCanvas (Á¢∫‰øùÂÆÉÂú® window.onload ‰πãÂâçË¢´ÂÆöÁæ©)
  function resizeCanvas() {
    const canvas = document.getElementById('signature-pad');
    if (!canvas || !signaturePad) return; // ÈåØË™§‰øùË≠∑
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    canvas.width = canvas.offsetWidth * ratio;
    canvas.height = canvas.offsetHeight * ratio;
    canvas.getContext("2d").scale(ratio, ratio);
    signaturePad.clear();
  }

  // 2. ÂàùÂßãÂåñ
  window.onload = function() {
    registerSW();
    checkNetworkStatus();

    // ËÆÄÂèñÂø´Âèñ
    loadFromCache();

    // ÂòóË©¶Êõ¥Êñ∞
    if (navigator.onLine) {
        forceUpdateCache(true); 
    }

    // UI ÂàùÂßãÂåñ
    const canvas = document.getElementById('signature-pad');
    if (canvas) {
        signaturePad = new SignaturePad(canvas, { backgroundColor: 'rgb(255, 255, 255)' });
        // Á∂ÅÂÆö Modal ‰∫ã‰ª∂
        const modalEl = document.getElementById('signModal');
        if(modalEl) modalEl.addEventListener('shown.bs.modal', resizeCanvas);
    }
    
    document.getElementById('inputUnit').addEventListener('input', handleUnitSearch);
    document.getElementById('inputPhoto').addEventListener('change', previewPhoto);

    updateSyncUI();
    autoSyncProcess();
  };

  // 3. Ë®ªÂÜä SW
  async function registerSW() {
    if ('serviceWorker' in navigator) {
      try {
        // Âä†‰∏ä timestamp Èò≤Ê≠¢ÁÄèË¶ΩÂô®Ê≠ªÈÉΩ‰∏çÊõ¥Êñ∞ sw.js
        await navigator.serviceWorker.register('sw.js?v=' + new Date().getTime());
        console.log('SW registered');
      } catch (e) { console.log('SW failed', e); }
    }
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault(); deferredPrompt = e;
      document.getElementById('installBtn').style.display = 'block';
    });
  }

  function installPWA() {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choice) => {
            if (choice.outcome === 'accepted') document.getElementById('installBtn').style.display = 'none';
        });
    }
  }

  // API ÂëºÂè´
  async function callApi(action, payload = null, method = 'GET') {
    let url = `${API_URL}?action=${action}`;
    let options = { method: method };

    if (method === 'POST') {
        options.body = JSON.stringify(payload);
        options.headers = { "Content-Type": "text/plain;charset=utf-8" };
    } else if (payload && method === 'GET') {
        url += `&q=${encodeURIComponent(payload)}`;
    }

    try {
        const response = await fetch(url, options);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return await response.json();
    } catch (error) {
        console.error("API Error:", error);
        throw error;
    }
  }

  // --- ÂÖ∂‰ªñÂäüËÉΩÂáΩÂºè (‰øùÊåÅ‰∏çËÆä) ---
  
  function loadFromCache() {
    const r = localStorage.getItem('p_residents');
    const c = localStorage.getItem('p_config');
    const i = localStorage.getItem('p_inventory');
    const statusEl = document.getElementById('cacheStatusText');

    if (r) {
        residentData = JSON.parse(r);
        statusEl.innerHTML = `‚úÖ Cached Data (${residentData.length} units)`;
        statusEl.className = "text-success fw-bold";
    } else {
        statusEl.innerHTML = `‚ö†Ô∏è No Data. Connect Internet!`;
        statusEl.className = "text-danger fw-bold";
    }
    if (c) { config = JSON.parse(c); applyConfig(config); }
    if (i) { allParcels = JSON.parse(i); renderPickupList(allParcels); updateInventoryMenu(allParcels); }
  }

  async function forceUpdateCache(silent = false) {
      if (!navigator.onLine) { if(!silent) Swal.fire("Offline", "No Internet", "warning"); return; }
      if (!silent) showLoading(true);

      try {
          const res = await callApi('getResidents');
          residentData = res;
          localStorage.setItem('p_residents', JSON.stringify(res));
          
          const conf = await callApi('getConfig');
          config = conf;
          localStorage.setItem('p_config', JSON.stringify(conf));
          applyConfig(conf);

          const inv = await callApi('getPending');
          allParcels = inv;
          localStorage.setItem('p_inventory', JSON.stringify(inv));
          renderPickupList(inv); 
          updateInventoryMenu(inv);

          document.getElementById('cacheStatusText').innerHTML = `‚úÖ Synced (${res.length} units)`;
          document.getElementById('cacheStatusText').className = "text-success fw-bold";
          
          if (!silent) { showLoading(false); Swal.fire("Synced!", "Data updated.", "success"); }

      } catch (e) {
          if (!silent) { showLoading(false); Swal.fire("Error", "Sync failed: " + e, "error"); }
      }
  }

  function addParcelToList() {
      const isManual = document.getElementById('chkManualEntry').checked;
      const photo = document.getElementById('inputPhoto');
      if (!isManual && !selectedResident) { Swal.fire("Notice", "Select resident", "warning"); return; }
      if (photo.files.length === 0) { Swal.fire("Notice", "Take photo", "warning"); return; }

      showLoading(true);
      compressImage(photo.files[0], 0.6, function(base64) {
          const item = {
              id: generateUUID(), timestamp: new Date().toISOString(),
              unit: isManual ? document.getElementById('manualUnit').value : selectedResident.unit,
              residentName: isManual ? document.getElementById('manualName').value : selectedResident.name,
              email: isManual ? "" : selectedResident.email,
              location: document.getElementById('inputLocation').value,
              courier: document.getElementById('inputCourier').value,
              photoBase64: base64, status: 'pending', isManual: isManual
          };
          tempBatch.push(item);
          renderTempList();
          resetForm();
          showLoading(false);
      });
  }

  function submitBatch() {
      let q = JSON.parse(localStorage.getItem('p_sync_queue') || '[]');
      q = [...q, ...tempBatch];
      localStorage.setItem('p_sync_queue', JSON.stringify(q));
      tempBatch = []; renderTempList(); updateSyncUI();
      Swal.fire("Saved", "Will sync when online.", "success");
      autoSyncProcess();
  }

  async function autoSyncProcess() {
      if (isSyncing || !navigator.onLine) return;
      let q = JSON.parse(localStorage.getItem('p_sync_queue') || '[]');
      if (q.length === 0) return;

      isSyncing = true; updateSyncUI();
      const item = q[0]; 

      try {
          const res = await callApi('receive', item, 'POST');
          if (res.success) {
              q.shift(); 
              localStorage.setItem('p_sync_queue', JSON.stringify(q));
              updateSyncUI();
              setTimeout(autoSyncProcess, 500); 
          } else {
              console.error("Sync fail", res);
              isSyncing = false;
          }
      } catch (e) {
          console.error("Sync error", e);
          isSyncing = false;
      }
  }

  async function searchHistory() {
      if (!navigator.onLine) return;
      const q = document.getElementById('historySearch').value;
      const res = await callApi('searchHistory', q, 'GET');
      const area = document.getElementById('historyListArea');
      area.innerHTML = '';
      res.forEach(p => {
          area.innerHTML += `<div class="card p-2 mb-2 shadow-sm"><div class="d-flex justify-content-between"><div><b>${p.unit}</b> ${p.name}<br><small>${p.courier} | ${p.timeOut}</small></div><button class="btn btn-sm btn-outline-primary" onclick="restore('${p.id}')">Restore</button></div></div>`;
      });
  }
  
  async function restore(id) {
     if(confirm("Restore this parcel?")) {
         showLoading(true);
         await callApi('restore', null, 'POST?action=restore&id='+id);
         showLoading(false);
         searchHistory();
     }
  }

  async function processPickup() {
     if (signaturePad.isEmpty()) return Swal.fire("Sign!", "", "warning");
     const sign = signaturePad.toDataURL().split(',')[1];
     bootstrap.Modal.getInstance(document.getElementById('signModal')).hide();
     showLoading(true);
     try {
         const res = await callApi('pickup', { ids: Array.from(selectedIds), signBase64: sign }, 'POST');
         if(res.success) {
             Swal.fire("Done!", "", "success");
             selectedIds.clear();
             forceUpdateCache(true); 
         }
     } catch(e) { Swal.fire("Error", e.toString(), "error"); }
     showLoading(false);
  }

  // --- Helpers ---
  function applyConfig(c) {
      const loc = document.getElementById('inputLocation'), cur = document.getElementById('inputCourier');
      loc.innerHTML = ''; cur.innerHTML = '';
      if(c.locations) c.locations.forEach(l => loc.add(new Option(l, l)));
      if(c.couriers) c.couriers.forEach(r => cur.add(new Option(r, r)));
  }
  
  function handleUnitSearch(e) {
      const v = e.target.value.toLowerCase(), dd = document.getElementById('unitDropdown');
      dd.innerHTML = '';
      if (v.length < 1) { dd.style.display = 'none'; return; }
      const matches = residentData.filter(r => r.label.toLowerCase().includes(v)).slice(0, 10);
      matches.forEach(m => {
          const div = document.createElement('div');
          div.className = 'dropdown-item';
          div.innerHTML = `<b>${m.unit}</b> - ${m.name}`;
          div.onclick = () => {
              document.getElementById('inputUnit').value = m.unit + " - " + m.name;
              selectedResident = m;
              dd.style.display = 'none';
              document.getElementById('emailWarning').style.display = m.hasEmail ? 'none' : 'block';
          };
          dd.appendChild(div);
      });
      dd.style.display = 'block';
  }

  function renderPickupList(data) {
      const area = document.getElementById('parcelListArea');
      area.innerHTML = '';
      data.forEach(p => {
          const isSelected = selectedIds.has(p.id);
          area.innerHTML += `<div class="parcel-card d-flex align-items-center p-2 ${isSelected?'selected':''}" onclick="toggleSelect('${p.id}')"><img src="${p.photo}" class="parcel-img"><div class="ms-3"><b>${p.unit}</b> ${p.name}<br><small>${p.location} | ${p.courier}</small></div></div>`;
      });
  }

  function updateInventoryMenu(data) {
      document.getElementById('invTotalBadge').innerText = `Total: ${data.length}`;
      const container = document.getElementById('invVisualizerArea');
      container.innerHTML = '';
      
      const groups = {};
      data.forEach(p => { const l = p.location||'Other'; if(!groups[l]) groups[l]=[]; groups[l].push(p); });
      
      Object.keys(groups).sort().forEach(loc => {
          let html = `<div class="inv-section"><div class="inv-header">${loc} <span class="badge bg-secondary">${groups[loc].length}</span></div><div class="inv-body"><div class="inv-chips">`;
          groups[loc].forEach(p => { html += `<div class="inv-chip" onclick="this.classList.toggle('checked')">${p.unit}</div>`; });
          html += `</div></div></div>`;
          container.innerHTML += html;
      });
  }

  function toggleSelect(id) {
     if(!navigator.onLine) return Swal.fire("Offline", "Go online to pickup", "info");
     if(selectedIds.has(id)) selectedIds.delete(id); else selectedIds.add(id);
     document.getElementById('selectedCount').innerText = selectedIds.size;
     document.getElementById('btnPickup').classList.toggle('d-none', selectedIds.size===0);
  }
  function previewPhoto(e) { if(e.target.files[0]) { const r = new FileReader(); r.onload=ev=>document.getElementById('previewImg').src=ev.target.result; r.readAsDataURL(e.target.files[0]); document.getElementById('photoPreview').classList.remove('d-none'); } }
  function resetForm() { document.getElementById('inputUnit').value=''; document.getElementById('inputPhoto').value=''; document.getElementById('photoPreview').classList.add('d-none'); selectedResident=null; }
  function updateSyncUI() { const q = JSON.parse(localStorage.getItem('p_sync_queue') || '[]'); const b = document.getElementById('syncCountBadge'); b.innerText = q.length; b.style.display = q.length>0 ? 'block':'none'; }
  function toggleManualEntry() { const m = document.getElementById('chkManualEntry').checked; document.getElementById('areaSearch').classList.toggle('d-none', m); document.getElementById('areaManual').classList.toggle('d-none', !m); }
  function checkNetworkStatus() { document.getElementById('offlineBanner').style.display = navigator.onLine ? 'none' : 'block'; }
  function switchTab(t, el) { document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active')); el.classList.add('active'); ['receive', 'pickup', 'history'].forEach(id => document.getElementById('tab-'+id).style.display = (id === t ? 'block' : 'none')); if(t==='pickup' && navigator.onLine) forceUpdateCache(true); if(t==='history') searchHistory(); }
  function generateUUID() { return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => { const r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8); return v.toString(16); }); }
  function compressImage(file, q, cb) { const r = new FileReader(); r.readAsDataURL(file); r.onload = e => { const i = new Image(); i.src = e.target.result; i.onload = () => { const c = document.createElement('canvas'); const max=800; let w=i.width, h=i.height; if(w>max){h=Math.round(h*(max/w));w=max;} c.width=w; c.height=h; c.getContext('2d').drawImage(i,0,0,w,h); cb(c.toDataURL('image/jpeg', q).split(',')[1]); } } }
  // --- UI Helper Functions ---
  function showLoading(s) {const el = document.getElementById('loadingOverlay');if (el) el.style.display = s ? 'flex' : 'none';
  }
</script>
</body>
</html>


